generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ─────────────────────────────────────

enum EstadoEntrega {
  PENDIENTE
  EN_REVISION
  REQUIERE_CORRECCION
  APROBADO
  NO_APROBADO
  NO_ENTREGADO
}

enum TipoPeriodo {
  ANUAL
  SEMESTRAL
  MENSUAL
}

// ─── Models ────────────────────────────────────

model Admin {
  id           String       @id @default(cuid())
  email        String       @unique
  password     String
  nombre       String
  role         String       @default("ATP_LECTOR")
  correcciones Correccion[]
}

model Escuela {
  id        String   @id @default(cuid())
  cct       String   @unique
  nombre    String
  localidad String
  municipio    String?
  zonaEscolar  String?
  codigoPostal String?
  email     String   @unique
  password  String
  director  String?
  hombres   Int      @default(0)
  mujeres   Int      @default(0)
  total     Int      @default(0)
  rol       String   @default("director")
  ultimoIngreso DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entregas Entrega[]
  configuraciones ConfiguracionPrograma[]
  inscripcionEvento InscripcionEvento2026?
  descargasCircular05 Circular05Descarga[]
}

model CicloEscolar {
  id     String   @id @default(cuid())
  nombre String   @unique // "2025-2026"
  inicio DateTime // 2025-08-01
  fin    DateTime // 2026-07-31
  activo Boolean  @default(true)
  anuncioGlobal String?

  periodos PeriodoEntrega[]
}

model Programa {
  id               String           @id @default(cuid())
  nombre           String           @unique
  descripcion      String?
  tipo             TipoPeriodo      @default(ANUAL)
  numArchivos      Int              @default(1) // Día Naranja = 2
  orden            Int              @default(0)
  recordatorioAuto Boolean          @default(false)
  createdAt        DateTime         @default(now())

  periodos PeriodoEntrega[]
  recursos Recurso[]
  configuraciones ConfiguracionPrograma[]
}

model PeriodoEntrega {
  id             String   @id @default(cuid())
  cicloEscolarId String
  programaId     String
  mes            Int?     // 1-12 para MENSUAL
  semestre       Int?     // 1 o 2 para SEMESTRAL
  activo         Boolean  @default(true)
  fechaLimite    DateTime?
  createdAt      DateTime @default(now())

  cicloEscolar CicloEscolar @relation(fields: [cicloEscolarId], references: [id])
  programa     Programa     @relation(fields: [programaId], references: [id])
  entregas     Entrega[]

  @@unique([cicloEscolarId, programaId, mes, semestre])
}

model Entrega {
  id               String         @id @default(cuid())
  escuelaId        String
  periodoEntregaId String
  estado           EstadoEntrega  @default(NO_ENTREGADO)
  observacionesATP String?
  fechaSubida      DateTime?
  fechaRevision    DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  escuela        Escuela        @relation(fields: [escuelaId], references: [id], onDelete: Cascade)
  periodoEntrega PeriodoEntrega @relation(fields: [periodoEntregaId], references: [id])
  archivos       Archivo[]
  correcciones   Correccion[]

  @@unique([escuelaId, periodoEntregaId])
}

model Archivo {
  id        String   @id @default(cuid())
  entregaId String
  nombre    String
  driveId   String?
  driveUrl  String?
  tipo      String   @default("ENTREGA") // ENTREGA | CORRECCION
  subidoPor String   @default("director") // director | atp
  etiqueta  String?  // "Registro", "Evidencias" (Día Naranja)
  createdAt DateTime @default(now())

  entrega    Entrega     @relation(fields: [entregaId], references: [id], onDelete: Cascade)
  correccion Correccion?
}

model Correccion {
  id         String   @id @default(cuid())
  entregaId  String
  texto      String?
  archivoId  String?  @unique
  adminId    String
  createdAt  DateTime @default(now())

  entrega  Entrega  @relation(fields: [entregaId], references: [id], onDelete: Cascade)
  archivo  Archivo? @relation(fields: [archivoId], references: [id])
  admin    Admin    @relation(fields: [adminId], references: [id])
}

model Recurso {
  id            String   @id @default(cuid())
  titulo        String
  descripcion   String?
  archivoNombre String
  archivoDriveId  String?
  archivoDriveUrl String?
  programaId    String?
  createdAt     DateTime @default(now())

  programa Programa? @relation(fields: [programaId], references: [id])
}

model ConfiguracionPrograma {
  id          String   @id @default(cuid())
  escuelaId   String
  programaId  String
  numArchivos Int      @default(1)
  createdAt   DateTime @default(now())

  escuela     Escuela  @relation(fields: [escuelaId], references: [id], onDelete: Cascade)
  programa    Programa @relation(fields: [programaId], references: [id], onDelete: Cascade)

  @@unique([escuelaId, programaId])
}

// ─── Eventos Culturales 2026 ─────────────────────

model CategoriaEvento {
  id          String   @id @default(cuid())
  nombre      String   @unique
  color       String   @default("#2e75b6")
  orden       Int      @default(0)
  createdAt   DateTime @default(now())

  disciplinas DisciplinaEvento[]
}

model DisciplinaEvento {
  id               String   @id @default(cuid())
  categoriaId      String
  nombre           String
  tipo             String   // "simple" | "individual" | "equipo" | "grupo"
  minParticipantes Int      @default(1)
  maxParticipantes Int      @default(1)
  grupoExclusion   String?  // ID de grupo para exclusión mutua (ej. "canto")
  orden            Int      @default(0)
  createdAt        DateTime @default(now())

  categoria        CategoriaEvento @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
}

model EventosConfig {
  id     String  @id @default("singleton")
  activo Boolean @default(false)
}

model InscripcionEvento2026 {
  id        String   @id @default(cuid())
  escuelaId String   @unique
  datos     Json     // { [disciplinaId]: { participa: boolean, numParticipantes: number } }
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  escuela   Escuela  @relation(fields: [escuelaId], references: [id], onDelete: Cascade)
}

// ─── Proyecto Circular 05 ────────────────────────

model Circular05Config {
  id                String  @id @default("singleton")
  activo            Boolean @default(false)
  destinatario      String  @default("ING. ALEJANDRO ESCAMILLA MARTINEZ")
  cargoDestinatario String  @default("SUPERVISOR ESCOLAR DE BACHILLERATOS GENERALES")
  zonaDestinatario  String  @default("ZONA 004, VENUSTIANO CARRANZA PUEBLA")
}

model Circular05Descarga {
  id        String   @id @default(cuid())
  escuelaId String
  datos     Json
  createdAt DateTime @default(now())

  escuela   Escuela  @relation(fields: [escuelaId], references: [id], onDelete: Cascade)
}
